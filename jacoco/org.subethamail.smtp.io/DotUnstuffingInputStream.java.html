<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DotUnstuffingInputStream.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">SubEtha SMTP</a> &gt; <a href="index.source.html" class="el_package">org.subethamail.smtp.io</a> &gt; <span class="el_source">DotUnstuffingInputStream.java</span></div><h1>DotUnstuffingInputStream.java</h1><pre class="source lang-java linenums">/***********************************************************************
 * Copyright (c) 2000-2006 The Apache Software Foundation. * All rights
 * reserved. *
 * ------------------------------------------------------------------- *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you * may not
 * use this file except in compliance with the License. You * may obtain a copy
 * of the License at: * * http://www.apache.org/licenses/LICENSE-2.0 * * Unless
 * required by applicable law or agreed to in writing, software * distributed
 * under the License is distributed on an &quot;AS IS&quot; BASIS, * WITHOUT WARRANTIES OR
 * CONDITIONS OF ANY KIND, either express or * implied. See the License for the
 * specific language governing * permissions and limitations under the License.
 * *
 ***********************************************************************/

package org.subethamail.smtp.io;

import java.io.FilterInputStream;
import java.io.IOException;
import java.io.InputStream;

/**
 * Removes the dot-stuffing happening during the NNTP and SMTP message transfer
 */
public class DotUnstuffingInputStream extends FilterInputStream {
	/**
	 * An array to hold the last two bytes read off the stream. This allows the
	 * stream to detect '\r\n' sequences even when they occur across read
	 * boundaries.
	 */
<span class="fc" id="L30">	protected int[] last = { -1, -1 };</span>

	public DotUnstuffingInputStream(final InputStream in) {
<span class="fc" id="L33">		super(in);</span>
<span class="fc" id="L34">	}</span>

	/**
	 * Read through the stream, checking for '\r\n.'
	 *
	 * @return the byte read from the stream
	 */
	@Override
	public int read() throws IOException {
<span class="fc" id="L43">		int b = this.in.read();</span>
<span class="pc bpc" id="L44" title="3 of 6 branches missed.">		if (b == '.' &amp;&amp; this.last[0] == '\r' &amp;&amp; this.last[1] == '\n') {</span>
			// skip this '.' because it should have been stuffed
<span class="nc" id="L46">			b = this.in.read();</span>
		}
<span class="fc" id="L48">		this.last[0] = this.last[1];</span>
<span class="fc" id="L49">		this.last[1] = b;</span>
<span class="fc" id="L50">		return b;</span>
	}

	/**
	 * Read through the stream, checking for '\r\n.'
	 *
	 * @param b   the byte array into which the bytes will be read
	 * @param off the offset into the byte array where the bytes will be inserted
	 * @param len the maximum number of bytes to be read off the stream
	 * @return the number of bytes read
	 */
	@Override
	public int read(final byte[] b, final int off, final int len) throws IOException {
<span class="pc bpc" id="L63" title="1 of 2 branches missed.">		if (b == null) {</span>
<span class="nc" id="L64">			throw new NullPointerException();</span>
		}
<span class="pc bpc" id="L66" title="5 of 10 branches missed.">		if (off &lt; 0 || off &gt; b.length || len &lt; 0 || off + len &gt; b.length || off + len &lt; 0) {</span>
<span class="nc" id="L67">			throw new IndexOutOfBoundsException();</span>
		}
<span class="pc bpc" id="L69" title="1 of 2 branches missed.">		if (len == 0) {</span>
<span class="nc" id="L70">			return 0;</span>
		}

<span class="fc" id="L73">		int c = this.read();</span>
<span class="fc bfc" id="L74" title="All 2 branches covered.">		if (c == -1) {</span>
<span class="fc" id="L75">			return -1;</span>
		}
<span class="fc" id="L77">		b[off] = (byte) c;</span>

<span class="fc" id="L79">		int i = 1;</span>

<span class="pc bpc" id="L81" title="1 of 2 branches missed.">		for (; i &lt; len; i++) {</span>
<span class="fc" id="L82">			c = this.read();</span>
<span class="fc bfc" id="L83" title="All 2 branches covered.">			if (c == -1) {</span>
<span class="fc" id="L84">				break;</span>
			}
<span class="fc" id="L86">			b[off + i] = (byte) c;</span>
		}

<span class="fc" id="L89">		return i;</span>
	}

	/**
	 * Provide access to the base input stream.
	 */
	public InputStream getBaseStream() {
<span class="nc" id="L96">		return this.in;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>